import streamlit as st
import cv2
import numpy as np
from PIL import Image, ImageDraw, ImageFont
import math
import tempfile
import os
import requests
import io

# --- 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ---
try:
    import arabic_reshaper
    from bidi.algorithm import get_display
    ARABIC_SUPPORT = True
except ImportError:
    st.error("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©: `pip install arabic-reshaper python-bidi`")
    st.stop()

try:
    from ultralytics import YOLO
except ImportError:
    st.error("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª YOLO: `pip install ultralytics`")
    st.stop()

# --- 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="Percepta Ultimate", page_icon="ğŸ›¡ï¸", layout="wide")

# ØªÙ†Ø³ÙŠÙ‚ CSS
st.markdown("""
<style>
.report-container { padding: 20px; border-radius: 10px; border: 1px solid #ddd; margin-top: 20px; }
.prob-box { background-color: #ffebee; border-right: 5px solid #c62828; padding: 15px; margin-bottom: 10px; direction: rtl; }
.risk-box { background-color: #fff3e0; border-right: 5px solid #ef6c00; padding: 15px; margin-bottom: 10px; direction: rtl; }
.sol-box  { background-color: #e8f5e9; border-right: 5px solid #2e7d32; padding: 15px; margin-bottom: 10px; direction: rtl; }
h4 { margin-top: 0; }
</style>
""", unsafe_allow_html=True)

# --- 3. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù„Ù…Ø¨Ø³Ø· ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ­) ---
with st.sidebar:
    st.image("https://img.icons8.com/color/96/sensor.png", width=80)
    st.title("ğŸ›ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø¯Ø§Ø±")
    st.markdown("---")

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡
    st.header("ğŸ‘ï¸ Ù‚ÙˆØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ø°ÙƒØ§Ø¡)")
    conf_thresh = st.slider("Ù…Ø¯Ù‰ Ø¯Ù‚Ø© Ø§Ù„ÙƒØ´Ù", 0.2, 0.8, 0.40)
    st.caption("""
    ğŸ’¡ **Ù…Ø§Ø°Ø§ ÙŠÙØ¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø±ØŸ**
    - **Ù„Ù„ÙŠØ³Ø§Ø± (Ù‚ÙŠÙ…Ø© Ù‚Ù„ÙŠÙ„Ø©):** ÙŠÙ„Ø§Ø­Ø¸ Ø£ÙŠ Ø­Ø±ÙƒØ© Ø­ØªÙ‰ Ù„Ùˆ Ø®ÙÙŠÙØ© (Ø­Ø³Ø§Ø³ Ø¬Ø¯Ø§Ù‹).
    - **Ù„Ù„ÙŠÙ…ÙŠÙ† (Ù‚ÙŠÙ…Ø© Ø¹Ø§Ù„ÙŠØ©):** Ù„Ø§ ÙŠÙ†Ø¨Ù‡Ùƒ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ£ÙƒØ¯Ø§Ù‹ 100% Ø£Ù†Ù‡ ÙŠØ±Ù‰ Ø¹Ø§Ù…Ù„Ø§Ù‹.
    """)

    st.markdown("---")

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
    st.header("ğŸ“ Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø£Ù…Ø§Ù†")
    high_risk_dist = st.slider("Ù…Ø³Ø§ÙØ© 'Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ù…Ù…ÙŠØª'", 0.01, 0.15, 0.08)
    st.caption("""
    ğŸ’¡ **Ù…ØªÙ‰ Ù†Ø·Ù„Ù‚ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ø£Ø­Ù…Ø±ØŸ**
    - ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø¢Ù„Ø©.
    - **Ù†ØµÙŠØ­Ø©:** Ø§Ù„Ù‚ÙŠÙ…Ø© 0.08 Ù…Ù…ØªØ§Ø²Ø© Ù„Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©.
    """)

    st.markdown("---")

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¢Ù„Ø§Øª
    st.header("ğŸšœ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¢Ù„Ø§Øª")
    machine_area_ratio = st.slider("Ø­Ø¬Ù… Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø®Ø·Ø±Ø©", 0.05, 0.5, 0.10)
    st.caption("""
    ğŸ’¡ **Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¢Ù„Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù†Ø¸Ø§Ù…ØŸ**
    - **Ù„Ù„ÙŠØ³Ø§Ø±:** ÙŠØ¹ØªØ¨Ø± Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„ØµØºÙŠØ±Ø© Ø¢Ù„Ø§Øª Ø®Ø·Ø±Ø©.
    - **Ù„Ù„ÙŠÙ…ÙŠÙ†:** ÙŠØ±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø© ÙˆØ§Ù„Ø±Ø§ÙØ¹Ø§Øª.
    """)
    st.markdown("---")
    st.info("â„¹ï¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªØ·Ø¨Ù‚ ÙÙˆØ±Ø§Ù‹.")

# --- 4. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„) ---
@st.cache_resource
def get_arabic_font():
    font_path = "Cairo-Bold.ttf"
    font_url = "https://github.com/google/fonts/raw/main/ofl/cairo/Cairo-Bold.ttf"
    
    # Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø®Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    if os.path.exists(font_path):
        try:
            return ImageFont.truetype(font_path, 22)
        except OSError:
            os.remove(font_path) # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªØ§Ù„Ù
            
    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„
    try:
        r = requests.get(font_url)
        if r.status_code == 200:
            with open(font_path, "wb") as f:
                f.write(r.content)
            return ImageFont.truetype(font_path, 22)
    except:
        pass
    return ImageFont.load_default()

def process_arabic_text(text):
    if ARABIC_SUPPORT:
        try:
            return get_display(arabic_reshaper.reshape(text))
        except:
            return text
    return text

@st.cache_resource
def load_model():
    return YOLO('yolov8n.pt')

try:
    model = load_model()
except Exception as e:
    st.error(f"Error loading model: {e}")
    st.stop()

def calculate_distance(box1, box2):
    c1 = ((box1[0] + box1[2])/2, (box1[1] + box1[3])/2)
    c2 = ((box2[0] + box2[2])/2, (box2[1] + box2[3])/2)
    return math.sqrt((c1[0]-c2[0])**2 + (c1[1]-c2[1])**2)

def get_risk_level(dist, img_diag):
    norm_dist = dist / img_diag
    if norm_dist < high_risk_dist: return "HIGH", (255, 0, 0)
    elif norm_dist < 0.15: return "MEDIUM", (255, 165, 0)
    return "LOW", (0, 255, 0)

def generate_report_text(status, stats):
    if status == "DANGER":
        return {
            "prob": f"ØªÙ… Ø±ØµØ¯ {stats['high_risk_count']} Ø­Ø§Ù„Ø§Øª Ù„ØªÙˆØ§Ø¬Ø¯ Ø¹Ù…Ø§Ù„ ÙÙŠ 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡' Ø§Ù„Ù…Ù„Ø§ØµÙ‚Ø© Ù„Ù„Ø¢Ù„Ø§Øª.",
            "risk": "Ø®Ø·Ø± Ø¯Ø§Ù‡Ù… Ù„Ù„Ø¥ØµØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¯Ù‡Ø³ØŒ Ø§Ù†Ø­Ø´Ø§Ø±ØŒ Ø£Ùˆ Ø§ØµØ·Ø¯Ø§Ù…) Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¹Ø¬Ø² Ø¯Ø§Ø¦Ù….",
            "sol": "1. Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø¢Ù„Ø§Øª.\n2. Ø¥Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„ Ù„Ù…Ø³Ø§ÙØ© Ø¢Ù…Ù†Ø©.\n3. Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©."
        }
    elif status == "WARNING":
        return {
            "prob": "Ø±ØµØ¯ ØªÙ‚Ø§Ø±Ø¨ ØºÙŠØ± Ø¢Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´Ø§Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª.",
            "risk": "Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© ÙˆÙ‚ÙˆØ¹ Ø­Ø§Ø¯Ø« ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ­Ø±Ùƒ Ø§Ù„Ù…ÙØ§Ø¬Ø¦.",
            "sol": "1. ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¹Ù…Ø§Ù„ ØµÙˆØªÙŠØ§Ù‹.\n2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø±ØªØ¯Ø§Ø¡ Ø§Ù„Ø³ØªØ±Ø§Øª."
        }
    else:
        return {
            "prob": "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ø³Ø§ÙØ§Øª Ù…Ø±Ø¦ÙŠØ©.",
            "risk": "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ù…Ù†Ø®ÙØ¶.",
            "sol": "1. Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠØ©."
        }

# --- 5. Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Processing) ---
def process_frame(image_pil):
    width, height = image_pil.size
    img_diag = math.sqrt(width**2 + height**2)
    
    results = model(image_pil, conf=conf_thresh, verbose=False)
    
    persons = []
    machines = []
    
    for r in results:
        boxes = r.boxes
        for box in boxes:
            x1, y1, x2, y2 = box.xyxy[0].tolist()
            cls = int(box.cls[0])
            area_ratio = ((x2-x1)*(y2-y1)) / (width*height)
            
            if cls == 0: 
                persons.append({'box': [x1, y1, x2, y2], 'risk': 'LOW', 'color': (0, 255, 0)})
            else:
                if area_ratio > machine_area_ratio:
                    machines.append({'box': [x1, y1, x2, y2]})

    global_risk_status = "SAFE"
    
    for p in persons:
        for m in machines:
            dist = calculate_distance(p['box'], m['box'])
            risk_lvl, color = get_risk_level(dist, img_diag)
            
            if risk_lvl == "HIGH":
                p['risk'] = "HIGH"
                p['color'] = (255, 0, 0)
                global_risk_status = "DANGER"
                break
            elif risk_lvl == "MEDIUM" and p['risk'] != "HIGH":
                p['risk'] = "MEDIUM"
                p['color'] = (255, 165, 0)
                if global_risk_status != "DANGER": global_risk_status = "WARNING"

    draw = ImageDraw.Draw(image_pil)
    font = get_arabic_font()
    
    for m in machines:
        draw.rectangle(m['box'], outline=(0, 0, 255), width=3)
        draw.text((m['box'][0], m['box'][1]-25), "Machine", fill=(0, 0, 255), font=font)

    for p in persons:
        draw.rectangle(p['box'], outline=p['color'], width=4)
        if p['risk'] in ["HIGH", "MEDIUM"]:
            overlay = Image.new('RGBA', image_pil.size, (0,0,0,0))
            d_overlay = ImageDraw.Draw(overlay)
            cx, cy = (p['box'][0]+p['box'][2])/2, (p['box'][1]+p['box'][3])/2
            radius = (p['box'][2]-p['box'][0])/1.5
            d_overlay.ellipse([cx-radius, cy-radius, cx+radius, cy+radius], fill=p['color']+(60,))
            image_pil = Image.alpha_composite(image_pil.convert('RGBA'), overlay).convert('RGB')
            draw = ImageDraw.Draw(image_pil)

    # Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙÙ„ÙŠ
    banner_height = 60
    new_img = Image.new("RGB", (width, height + banner_height), (20, 20, 20))
    new_img.paste(image_pil, (0, 0))
    d_banner = ImageDraw.Draw(new_img)
    
    if global_risk_status == "DANGER":
        msg_ar = "âš ï¸ Ø®Ø·Ø±: Ø§Ù‚ØªØ±Ø§Ø¨ Ø´Ø¯ÙŠØ¯!"
        bg_color = (200, 0, 0)
    elif global_risk_status == "WARNING":
        msg_ar = "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù†ØªØ¨Ù‡ Ù„Ù„Ù…Ø³Ø§ÙØ§Øª"
        bg_color = (255, 140, 0)
    else:
        msg_ar = "âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø¢Ù…Ù†Ø©"
        bg_color = (0, 100, 0)
        
    d_banner.rectangle([0, height, width, height+banner_height], fill=bg_color)
    ar_text = process_arabic_text(msg_ar)
    
    try:
        text_w = d_banner.textlength(ar_text, font=font)
        d_banner.text((width - 20 - text_w, height + 15), ar_text, font=font, fill="white")
    except:
        d_banner.text((width - 150, height + 15), ar_text, font=font, fill="white")

    stats = {
        "persons": len(persons),
        "machines": len(machines),
        "status": global_risk_status,
        "high_risk_count": sum(1 for p in persons if p['risk'] == "HIGH")
    }
    return new_img, stats

# --- 6. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Main UI) ---
st.title("ğŸ›¡ï¸ Percepta: Industrial Safety AI")
st.markdown("##### Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±")

uploaded_file = st.file_uploader("Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©", type=['jpg', 'png', 'jpeg', 'mp4'])

if uploaded_file:
    if uploaded_file.type.startswith('image'):
        image = Image.open(uploaded_file).convert('RGB')
        
        with st.spinner('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„...'):
            processed_img, stats = process_frame(image)
            
        c1, c2, c3 = st.columns(3)
        c1.metric("Ø§Ù„Ø¹Ù…Ø§Ù„", stats['persons'])
        c2.metric("Ø§Ù„Ø¢Ù„Ø§Øª", stats['machines'])
        c3.metric("Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ù…Ø±Ø§Ø¡", stats['high_risk_count'], delta_color="inverse")
        
        st.image(processed_img, use_container_width=True)
        
        st.divider()
        st.subheader("ğŸ“‹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…ÙØµÙ„")
        report_content = generate_report_text(stats['status'], stats)
        
        st.markdown(f"""
        <div class="report-container">
            <div class="prob-box"><h4>ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</h4>{report_content['prob']}</div>
            <div class="risk-box"><h4>ğŸŸ  Ø§Ù„Ø®Ø·Ø±:</h4>{report_content['risk']}</div>
            <div class="sol-box"><h4>ğŸŸ¢ Ø§Ù„Ø­Ù„:</h4>{report_content['sol']}</div>
        </div>
        """, unsafe_allow_html=True)
        
        buf = io.BytesIO()
        processed_img.save(buf, format="JPEG")
        st.download_button("ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", data=buf.getvalue(), file_name="percepta_report.jpg", mime="image/jpeg")

    elif uploaded_file.type.startswith('video'):
        tfile = tempfile.NamedTemporaryFile(delete=False) 
        tfile.write(uploaded_file.read())
        cap = cv2.VideoCapture(tfile.name)
        st_frame = st.empty()
        curr_frame = 0
        while cap.isOpened():
            ret, frame = cap.read()
            if not ret: break
            if curr_frame % 5 == 0:
                frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                processed_img, _ = process_frame(Image.fromarray(frame_rgb))
                st_frame.image(processed_img, use_container_width=True)
            curr_frame += 1
        cap.release()
else:
    st.info("ğŸ‘† ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ù„Ù„Ø¨Ø¯Ø¡")